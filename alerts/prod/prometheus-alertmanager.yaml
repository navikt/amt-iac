apiVersion: monitoring.coreos.com/v1alpha1
kind: AlertmanagerConfig
metadata:
  name: amt-alertmanager-config
  namespace: amt
  labels:
    team: amt
    alertmanagerConfig: amt-alertmanager-config
spec:
  receivers:
    # Receiver for firing alerts
    - name: amt-custom-slack-firing
      slackConfigs:
        - apiURL:
            key: apiUrl
            name: slack-webhook
          channel: "#team_komet_alerts"
          iconEmoji: ":nav-on-fire:"
          username: "KOMET alertmanager"
          sendResolved: false
          title: |-
            :nav-on-fire: [{{ .Status | toUpper }}:{{ .Alerts.Firing | len }}] {{ .CommonLabels.alertname }}
          text: >-
            {{ range .Alerts -}}
              *Severity:* `{{ .Labels.severity | toUpper }}`
              *Title:* {{ .Annotations.title }}
              *Summary:* {{ .Annotations.summary }}
              *Action:* {{ .Annotations.action }}
            {{- end }}
          color: |-
            {{ if eq .Status "firing" -}}
              {{ if eq .CommonLabels.severity "fatal" -}}
                #ff0000
              {{- else if eq .CommonLabels.severity "critical" -}}
                #ff0000
              {{- else if eq .CommonLabels.severity "danger" -}}
                danger
              {{- else if eq .CommonLabels.severity "error" -}}
                danger
              {{- else if eq .CommonLabels.severity "warning" -}}
                warning
              {{- else if eq .CommonLabels.severity "notice" -}}
                good
              {{- else if eq .CommonLabels.severity "info" -}}
                #8ab4f8
              {{- else -}}
                .CommonLabels.severity
              {{- end -}}
            {{ else -}}
                good
            {{- end }}

    # Receiver for resolved alerts
    - name: amt-custom-slack-resolved
      slackConfigs:
        - apiURL:
            key: apiUrl
            name: slack-webhook
          channel: "#team_komet_alerts"
          iconEmoji: ":white_check_mark:"
          username: "KOMET alertmanager"
          sendResolved: true
          title: |-
            :white_check_mark: [RESOLVED] {{ .CommonLabels.alertname }}
          text: >-
            {{ range .Alerts -}}
              *Title:* {{ .Annotations.resolved }}
            {{- end }}
          color: good

  route:
    groupWait: 5s
    groupInterval: 10s
    repeatInterval: 30m
    groupBy:
      - alertname
    receiver: amt-custom-slack-receiver
    matchers:
      - name: "namespace"
        value: "amt"
        matchType: "="
      - name: "alert_type"
        matchType: "="
        value: "custom"
    routes:
      - receiver: amt-custom-slack-firing
        matchers:
          - name: "namespace"
            value: "amt"
            matchType: "="
          - name: "alert_type"
            value: "custom"
            matchType: "="
        continue: true
      - receiver: amt-custom-slack-resolved
        matchers:
          - name: "namespace"
            value: "amt"
            matchType: "="
          - name: "alert_type"
            value: "custom"
            matchType: "="
